# .gitlab-ci.yml - Debug simples
image: openjdk:17

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"

cache:
  paths:
    - .m2/repository/

stages:
  - debug
  - build
  - test

# Stage para debug
debug:
  stage: debug
  script:
    - echo "🔍 Environment info:"
    - java -version
    - chmod +x mvnw
    - ./mvnw --version
    - echo "📁 Project structure:"
    - ls -la
    - echo "🧪 Test files:"
    - find src/test -name "*.java" | head -5 || echo "No test files found"
    - echo "📦 Dependencies check:"
    - ./mvnw dependency:tree | grep -E "(h2|mysql)" || echo "No H2 or MySQL found"

build:
  stage: build
  script:
    - echo "🏗️ Building..."
    - chmod +x mvnw
    - ./mvnw clean compile --batch-mode
    - echo "✅ Build OK!"

test:
  stage: test
  script:
    - echo "🧪 Testing..."
    - chmod +x mvnw
    # Tentar rodar um teste simples primeiro
    - ./mvnw test --batch-mode -Dmaven.test.failure.ignore=true
    # Ver se gerou algum relatório
    - echo "📋 Checking reports:"
    - ls -la target/ || echo "No target directory"
    - ls -la target/surefire-reports/ || echo "No surefire-reports"
    - find . -name "*.xml" -path "*/surefire-reports/*" || echo "No XML reports found"
  artifacts:
    when: always
    paths:
      - target/
    expire_in: 1 hour
  allow_failure: true