# .gitlab-ci.yml - Pipeline Simplificado para Fase 1
image: openjdk:17-jdk-slim

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

# Cache para acelerar builds
cache:
  paths:
    - .m2/repository/
    - target/

# Estágios do pipeline
stages:
  - test
  - build
  - deploy

# Script executado antes de cada job
before_script:
  - apt-get update -qq && apt-get install -y -qq git curl mysql-client
  - chmod +x mvnw

# ================== TEST STAGE ==================
unit_tests:
  stage: test
  services:
    - name: mysql:8.0
      alias: mysql
      command: ["--default-authentication-plugin=mysql_native_password"]
  variables:
    SPRING_PROFILES_ACTIVE: test
    SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/sd3_test
    SPRING_DATASOURCE_USERNAME: testuser
    SPRING_DATASOURCE_PASSWORD: testpass
    MYSQL_ROOT_PASSWORD: root
    MYSQL_DATABASE: sd3_test
    MYSQL_USER: testuser
    MYSQL_PASSWORD: testpass
  before_script:
    - apt-get update -qq && apt-get install -y -qq git curl mysql-client
    - chmod +x mvnw
    # Aguardar MySQL ficar disponível
    - |
      echo "Waiting for MySQL to be ready..."
      until mysql -h mysql -u root -proot -e "SELECT 1"; do
        echo "MySQL is unavailable - sleeping"
        sleep 3
      done
      echo "MySQL is ready!"
    # Configurar banco de teste
    - mysql -h mysql -u root -proot -e "CREATE DATABASE IF NOT EXISTS sd3_test;"
    - mysql -h mysql -u root -proot -e "CREATE USER IF NOT EXISTS 'testuser'@'%' IDENTIFIED BY 'testpass';"
    - mysql -h mysql -u root -proot -e "GRANT ALL PRIVILEGES ON sd3_test.* TO 'testuser'@'%';"
    - mysql -h mysql -u root -proot -e "FLUSH PRIVILEGES;"
    - echo "Database setup completed"
  script:
    - echo "Running tests..."
    - ./mvnw $MAVEN_CLI_OPTS clean test
    - echo "Tests completed"
  artifacts:
    when: always
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
    paths:
      - target/surefire-reports/
    expire_in: 1 week
  only:
    - main
    - develop
    - merge_requests

# ================== BUILD STAGE ==================
build:
  stage: build
  script:
    - echo "Building application..."
    - ./mvnw $MAVEN_CLI_OPTS clean package -DskipTests
    - echo "Build completed"
    - ls -la target/*.jar
  artifacts:
    name: "ds3-api-$CI_COMMIT_SHORT_SHA"
    paths:
      - target/*.jar
    expire_in: 1 week
  only:
    - main
    - develop
    - merge_requests

# ================== DEPLOY STAGE ==================
deploy_info:
  stage: deploy
  script:
    - echo "Deployment stage completed"
    - echo "Artifact built successfully and ready for deployment"
    - echo "JAR file available in artifacts"
  dependencies:
    - build
  only:
    - main
    - develop