# .gitlab-ci.yml - Com H2 para testes
image: openjdk:17

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"

cache:
  paths:
    - .m2/repository/

stages:
  - build
  - test

build:
  stage: build
  script:
    - echo "🏗️ Building application..."
    - chmod +x mvnw
    - ./mvnw clean compile -B
    - echo "✅ Build completed!"

test:
  stage: test
  script:
    - echo "🧪 Running tests with H2 database..."
    - chmod +x mvnw
    # Use H2 database for tests (no external MySQL needed)
    - ./mvnw test -B -Dspring.datasource.url=jdbc:h2:mem:testdb -Dspring.datasource.driver-class-name=org.h2.Driver -Dspring.jpa.hibernate.ddl-auto=create-drop
    - echo "✅ Tests completed!"
  artifacts:
    when: always
    reports:
      junit: target/surefire-reports/TEST-*.xml
    paths:
      - target/surefire-reports/
    expire_in: 1 week
  allow_failure: true

package:
  stage: test
  script:
    - echo "📦 Creating final package..."
    - chmod +x mvnw
    - ./mvnw clean package -DskipTests -B
    - echo "✅ Package created!"
    - ls -la target/*.jar
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 week