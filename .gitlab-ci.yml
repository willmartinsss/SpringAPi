# .gitlab-ci.yml - Super Simples
image: maven:3.9-openjdk-17

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"

cache:
  paths:
    - .m2/repository/

stages:
  - test
  - build

test:
  stage: test
  services:
    - name: mysql:8.0
      alias: mysql
  variables:
    MYSQL_ROOT_PASSWORD: root
    MYSQL_DATABASE: sd3_test
    MYSQL_USER: testuser
    MYSQL_PASSWORD: testpass
    SPRING_PROFILES_ACTIVE: test
    SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/sd3_test
    SPRING_DATASOURCE_USERNAME: testuser
    SPRING_DATASOURCE_PASSWORD: testpass
  script:
    # Simple wait for MySQL
    - sleep 30
    # Setup database using SQL commands through Maven
    - |
      mysql -h mysql -u root -proot -e "
        CREATE DATABASE IF NOT EXISTS sd3_test;
        CREATE USER IF NOT EXISTS 'testuser'@'%' IDENTIFIED BY 'testpass';
        GRANT ALL PRIVILEGES ON sd3_test.* TO 'testuser'@'%';
        FLUSH PRIVILEGES;
      " || echo "Database setup failed, but continuing..."
    # Run tests
    - mvn clean test -B
  artifacts:
    when: always
    reports:
      junit: target/surefire-reports/TEST-*.xml

build:
  stage: build
  script:
    - mvn clean package -DskipTests -B
  artifacts:
    paths:
      - target/*.jar